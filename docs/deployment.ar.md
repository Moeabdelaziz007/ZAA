# دليل النشر

## المتطلبات الأساسية
- تثبيت Docker و Docker Compose
- شهادات SSL (لـ HTTPS)

## النشر في بيئة الإنتاج

1. استنساخ المستودع:
```bash
git clone https://github.com/yourusername/zentix-clean.git
cd zentix-clean
```

2. إنشاء مجلد SSL وإضافة الشهادات:
```bash
mkdir ssl
# أضف شهادات SSL إلى مجلد ssl
# - ssl/cert.pem
# - ssl/key.pem
```

3. بناء وتشغيل الحاويات:
```bash
docker-compose up -d --build
```

سيكون التطبيق متاحاً على:
- الواجهة الأمامية: http://localhost
- واجهة برمجة التطبيقات: http://localhost/api
- توثيق واجهة برمجة التطبيقات: http://localhost/api/docs

## تحسينات الأداء

يتضمن المشروع عدة تحسينات للأداء:

### 1. إعدادات Nginx
- ضغط Gzip و Brotli
- تخزين الملفات الثابتة مؤقتاً
- تخزين استجابات API مؤقتاً
- رؤوس الأمان
- موازنة الحمل

### 2. تحسينات الواجهة الأمامية
- تحسين الملفات الثابتة
- تحسين الصور
- تقسيم الكود
- رؤوس التخزين المؤقت
- الضغط

### 3. تحسينات الخلفية
- ضغط الاستجابات
- وسيط التخزين المؤقت
- مراقبة الأداء
- تجميع اتصالات قاعدة البيانات

## المراقبة

يتضمن التطبيق مراقبة مدمجة:

### 1. مقاييس الأداء
- وقت معالجة الطلبات
- أحجام الاستجابات
- معدلات نجاح التخزين المؤقت
- معدلات الأخطاء

### 2. فحوصات الصحة
- نقطة نهاية صحة API: `/api/health`
- حالة اتصال قاعدة البيانات
- حالة تبعيات الخدمة

## التوسع

تم تصميم التطبيق للتوسع الأفقي:

### 1. الواجهة الأمامية
- تصميم بدون حالة
- أصول ثابتة جاهزة لشبكة CDN
- متوافق مع موازن الحمل

### 2. الخلفية
- تصميم API بدون حالة
- تجميع اتصالات قاعدة البيانات
- بنية صديقة للتخزين المؤقت

### 3. قاعدة البيانات
- تجميع الاتصالات
- استعلامات مفهرسة
- مخطط محسن

## متغيرات البيئة

### الواجهة الأمامية
```env
NEXT_PUBLIC_API_URL=https://api.example.com/api
NODE_ENV=production
```

### الخلفية
```env
DATABASE_URL=postgresql://postgres:postgres@db:5432/zentix
ENVIRONMENT=production
```

### قاعدة البيانات
```env
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=zentix
```

## النشر على Vercel

يُعرّف ملف `vercel.json` إعدادات مشروع Next.js، حيث يحدد مجلد `frontend`
كجذر للتطبيق ويضبط أمر البناء ومجلد المخرجات، إضافةً إلى إعادة توجيه
طلبات `/api` إلى عنوان الخلفية. يمكن تعريف متغيرات البيئة في هذا الملف أو
عبر لوحة تحكم Vercel، وأهمها `NEXT_PUBLIC_API_URL` الذي يجب أن يشير إلى
رابط الواجهة الخلفية. سيتوقف بناء الإنتاج إذا لم يكن هذا المتغير محدداً.

### متغيرات البيئة المطلوبة
- `VERCEL_TOKEN` – رمز المصادقة لأداة `vercel`
- `VERCEL_ORG_ID` – معرف المؤسسة في Vercel
- `VERCEL_PROJECT_ID` – معرف المشروع على Vercel

### أوامر vercel CLI
1. تثبيت الأداة:
   ```bash
   npm install -g vercel
   ```
2. تسجيل الدخول:
   ```bash
   vercel login
   ```
3. إنشاء نشر للمعاينة:
   ```bash
   vercel
   ```
4. النشر في الإنتاج من مجلد `frontend`:
   ```bash
   vercel --prod
   ```

  ### معالجة الخلفية
يتم استضافة الخلفية بشكل منفصل (Docker أو خدمة سحابية) مع إتاحة عنوانها العام، ثم ضبط `NEXT_PUBLIC_API_URL` في لوحة Vercel أو في `vercel.json` حتى تتمكن الواجهة الأمامية من الوصول إلى واجهة البرمجة. سيفشل بناء الإنتاج إذا لم يكن هذا المتغير محدداً.

  ### ملف vercel.json
  يحدّد ملف `vercel.json` إعدادات المشروع ومجلد
  `frontend` كجذر، ويضبط أوامر البناء ومجلد النتائج،
  كما يعرّف المتغيرات اللازمة لتشغيل تطبيق
  Next.js:

  - `NEXT_PUBLIC_API_URL` – رابط خدمة الباكند
  - `NEXT_PUBLIC_JWT_STORAGE_KEY` – مفتاح تخزين رمز المصادقة

تتم إعادة كتابة الطلبات التي تبدأ بـ`/api/` إلى عنوان الخلفية كي يبقى العنوان موحداً. حدّث الرابط الافتراضي `http://localhost:5000/api` بما يناسب بيئة الإنتاج.

## الصيانة

### السجلات
عرض سجلات جميع الخدمات:
```bash
docker-compose logs -f
```

عرض سجلات خدمة محددة:
```bash
docker-compose logs -f [service_name]
```

### التحديثات
لتحديث التطبيق:
1. سحب أحدث التغييرات
2. إعادة بناء الحاويات
```bash
git pull
docker-compose up -d --build
```

### النسخ الاحتياطي
نسخ قاعدة البيانات احتياطياً:
```bash
docker-compose exec db pg_dump -U postgres zentix > backup.sql
```

استعادة قاعدة البيانات:
```bash
cat backup.sql | docker-compose exec -T db psql -U postgres zentix
```

## استكشاف الأخطاء وإصلاحها

### المشكلات الشائعة

1. **تعارض المنافذ**
   - تحقق من توفر المنافذ 80 و 443
   - تعديل المنافذ في docker-compose.yml إذا لزم الأمر

2. **اتصال قاعدة البيانات**
   - التحقق من بيانات اعتماد قاعدة البيانات
   - فحص سجلات قاعدة البيانات للأخطاء

3. **مشكلات SSL**
   - التأكد من صلاحية شهادات SSL
   - فحص أذونات الشهادات

4. **مشكلات الذاكرة**
   - مراقبة استخدام ذاكرة الحاويات
   - ضبط حدود الحاويات إذا لزم الأمر

### التصحيح

1. **حالة الحاويات**
```bash
docker-compose ps
```

2. **سجلات الحاويات**
```bash
docker-compose logs [service_name]
```

3. **قشرة الحاويات**
```bash
docker-compose exec [service_name] sh
```

## الأمان

### SSL/TLS
- استخدام شهادات SSL صالحة
- تمكين HTTPS فقط
- تكوين رؤوس آمنة

### قاعدة البيانات
- استخدام كلمات مرور قوية
- نسخ احتياطية منتظمة
- التحكم في الوصول

### التطبيق
- تحديثات منتظمة
- رؤوس الأمان
- التحقق من صحة المدخلات
- تحديد معدل الطلبات 
